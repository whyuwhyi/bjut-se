name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æµ‹è¯•é˜¶æ®µ
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: wechat_education_test
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
          MYSQL_CHARACTER_SET_SERVER: utf8mb4
          MYSQL_COLLATION_SERVER: utf8mb4_0900_ai_ci
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        # ä½¿ç”¨æˆ‘ä»¬çš„ç»Ÿä¸€è„šæœ¬æ¥å®‰è£…ä¾èµ–ï¼ˆåŒ…å«ç®¡ç†åå°ï¼‰
        chmod +x scripts/dev.sh
        scripts/dev.sh install-deps || {
          # å¦‚æœè„šæœ¬ä¸æ”¯æŒinstall-depså‘½ä»¤ï¼Œåˆ™ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
          cd frontend
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          cd ../admin-frontend
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          cd ../backend
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          cd ..
        }

    - name: è¿è¡Œæµ‹è¯•
      run: |
        # ä½¿ç”¨æˆ‘ä»¬çš„ç»Ÿä¸€è„šæœ¬è¿è¡Œæµ‹è¯•
        chmod +x scripts/dev.sh
        scripts/dev.sh test || {
          # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥è¿è¡Œæµ‹è¯•
          echo "ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼è¿è¡Œæµ‹è¯•"
          cd frontend
          if npm run --silent test:h5 2>/dev/null; then
            npm run test:h5
          else
            echo "å‰ç«¯æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          cd ..
          
          cd backend
          if npm run --silent test 2>/dev/null; then
            npm test
          else
            echo "åç«¯æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          cd ..
        }
      env:
        NODE_ENV: test
        DB_HOST: localhost
        DB_PORT: 3306
        DB_NAME: wechat_education_test
        DB_USER: testuser
        DB_PASSWORD: testpass
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        JWT_SECRET: test-secret

    - name: è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
      run: |
        cd backend
        if npm run --silent lint 2>/dev/null; then
          npm run lint
        else
          echo "Lintè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡ä»£ç è´¨é‡æ£€æŸ¥"
        fi

  # æ„å»ºé˜¶æ®µ
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        chmod +x scripts/dev.sh
        cd frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        cd ../admin-frontend
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        cd ..

    - name: æ„å»ºå‰ç«¯H5
      run: |
        cd frontend
        npm run build:h5

    - name: æ„å»ºç®¡ç†åå°
      run: |
        cd admin-frontend
        npm run build

    - name: ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/build/h5/
        retention-days: 7

    - name: ä¸Šä¼ ç®¡ç†åå°æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: admin-dist
        path: admin-frontend/dist/
        retention-days: 7

  # Dockeré•œåƒæ„å»º
  docker-build:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–å…ƒæ•°æ®
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend

    - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./docker/backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æå–å‰ç«¯å…ƒæ•°æ®
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend

    - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æå–ç®¡ç†åå°å…ƒæ•°æ®
      id: meta-admin
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-admin

    - name: æ„å»ºå¹¶æ¨é€ç®¡ç†åå°é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./admin-frontend
        file: ./docker/admin-frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-admin.outputs.tags }}
        labels: ${{ steps.meta-admin.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    environment: production
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /opt/wechat-education
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d "current" ]; then
            mv current backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          # ä½¿ç”¨gitè·å–æœ€æ–°ä»£ç 
          echo "è·å–æœ€æ–°ä»£ç ..."
          if [ -d "current" ]; then
            rm -rf current
          fi
          if git clone https://github.com/${{ github.repository }}.git current; then
            echo "âœ… ä»£ç è·å–æˆåŠŸ"
          else
            LATEST_BACKUP=$(ls -t backup-* 2>/dev/null | head -n 1)
            if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              cp -r "$LATEST_BACKUP" current
              echo "âš ï¸ Gitå…‹éš†å¤±è´¥ï¼Œä½¿ç”¨æœ€æ–°å¤‡ä»½: $LATEST_BACKUP"
            else
              echo "âŒ Gitå…‹éš†å¤±è´¥ä¸”æ— å¤‡ä»½å¯ç”¨"
              exit 1
            fi
          fi
          cd current
          
          # åˆ›å»ºç¯å¢ƒé…ç½®
          if [ -f .env.production ]; then
            cp .env.production .env
          elif [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒé…ç½®æ¨¡æ¿"
          fi
          
          # æ¸…ç†æ—§å®¹å™¨ï¼ˆä¿ç•™åŸºç¡€é•œåƒï¼‰
          echo "æ¸…ç†æ—§å®¹å™¨..."
          docker rm -f $(docker ps -aq --filter "name=wechat-education") 2>/dev/null || true
          
          # åªåˆ é™¤åº”ç”¨é•œåƒï¼Œä¿ç•™MySQLã€Redisã€Nginxç­‰åŸºç¡€é•œåƒ
          docker rmi $(docker images | grep "docker.*backend" | awk '{print $3}') 2>/dev/null || true
          docker rmi $(docker images | grep "docker.*frontend" | awk '{print $3}') 2>/dev/null || true
          docker rmi $(docker images | grep "docker.*admin" | awk '{print $3}') 2>/dev/null || true
          
          # åœæ­¢æ—§æœåŠ¡
          docker-compose -f docker/docker-compose.prod.yml down 2>/dev/null || true
          
          # è®¾ç½®æ„å»ºè¶…æ—¶å¹¶é‡æ–°æ„å»ºåº”ç”¨é•œåƒï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
          export COMPOSE_HTTP_TIMEOUT=1200
          export DOCKER_CLIENT_TIMEOUT=1200
          docker-compose -f docker/docker-compose.prod.yml build --parallel
          
          # å¯åŠ¨æ–°æœåŠ¡
          docker-compose -f docker/docker-compose.prod.yml up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 60
          
          # å¥åº·æ£€æŸ¥ - æ£€æŸ¥å®¹å™¨çŠ¶æ€è€Œä¸æ˜¯HTTPç«¯ç‚¹
          max_attempts=6
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            # æ£€æŸ¥æ‰€æœ‰æœåŠ¡æ˜¯å¦å¥åº·
            if docker-compose -f docker/docker-compose.prod.yml ps | grep -q "backend.*Up (healthy)" && \
               docker-compose -f docker/docker-compose.prod.yml ps | grep -q "admin.*Up (healthy)" && \
               docker-compose -f docker/docker-compose.prod.yml ps | grep -q "nginx.*Up (healthy)"; then
              echo "âœ… æ‰€æœ‰å®¹å™¨æœåŠ¡æ­£å¸¸"
              
              # å°è¯•è®¿é—®Nginxï¼ˆå¯¹å¤–æœåŠ¡ï¼‰
              if curl -f http://localhost/ --connect-timeout 5 2>/dev/null; then
                echo "âœ… å‰ç«¯æœåŠ¡å¯è®¿é—®"
              fi
              
              # å°è¯•è®¿é—®ç®¡ç†åå°
              if curl -f http://localhost/admin/ --connect-timeout 5 2>/dev/null; then
                echo "âœ… ç®¡ç†åå°å¯è®¿é—®"
              fi
              
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
              cd ..
              ls -t backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
              cd current
              exit 0
            else
              echo "å°è¯• $attempt/$max_attempts: å®¹å™¨å°šæœªå®Œå…¨å°±ç»ªï¼Œç­‰å¾…15ç§’..."
              docker-compose -f docker/docker-compose.prod.yml ps
              sleep 15
              attempt=$((attempt + 1))
            fi
          done
          
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ŒæœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œå¼€å§‹å›æ»š..."
          docker-compose -f docker/docker-compose.prod.yml logs --tail=50
          docker-compose -f docker/docker-compose.prod.yml down
          
          # å›æ»šåˆ°æœ€æ–°çš„å¤‡ä»½ç‰ˆæœ¬
          cd ..
          LATEST_BACKUP=$(ls -t backup-* 2>/dev/null | head -n 1)
          if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
            echo "å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬: $LATEST_BACKUP"
            rm -rf current
            cp -r "$LATEST_BACKUP" current
            cd current
            docker-compose -f docker/docker-compose.prod.yml up -d
            echo "ğŸ”„ å·²å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬: $LATEST_BACKUP"
          else
            echo "âŒ æ²¡æœ‰å¯ç”¨çš„å¤‡ä»½ç‰ˆæœ¬è¿›è¡Œå›æ»š"
            # å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œè‡³å°‘å°è¯•é‡æ–°å…‹éš†ä»£ç 
            echo "å°è¯•é‡æ–°è·å–ä»£ç ..."
            if [ -d "current" ]; then
              rm -rf current
            fi
            if git clone https://github.com/${{ github.repository }}.git current; then
              echo "âœ… é‡æ–°è·å–ä»£ç æˆåŠŸ"
              cd current
            else
              echo "âŒ é‡æ–°è·å–ä»£ç å¤±è´¥"
            fi
          fi
          exit 1

  # é€šçŸ¥
  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: github.ref == 'refs/heads/main'
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼åº”ç”¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        fi