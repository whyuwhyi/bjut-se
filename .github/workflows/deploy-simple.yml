name: Simple Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  # ç®€åŒ–çš„éƒ¨ç½²ä»»åŠ¡
  deploy:
    runs-on: ubuntu-latest
    
    environment: production
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p /opt/wechat-education
          cd /opt/wechat-education
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d "current" ]; then
            mv current backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
          fi
          
          # å…‹éš†æœ€æ–°ä»£ç 
          git clone https://github.com/${{ github.repository }}.git current
          cd current
          
          # ä½¿ç”¨ç»Ÿä¸€è„šæœ¬å®‰è£…ä¾èµ–
          chmod +x scripts/dev.sh
          npm install
          cd backend && npm install && cd ..
          
          # åˆ›å»ºç¯å¢ƒé…ç½®
          if [ -f .env.production ]; then
            cp .env.production .env
          else
            cat > .env << 'EOF'
          NODE_ENV=production
          MYSQL_ROOT_PASSWORD=secure_root_pass_2024
          MYSQL_DATABASE=wechat_education
          MYSQL_USER=appuser
          MYSQL_PASSWORD=secure_app_pass_2024
          MYSQL_PORT=3306
          REDIS_PORT=6379
          JWT_SECRET=your_very_secure_jwt_secret_key_change_this_in_production_2024
          BACKEND_PORT=3000
          NGINX_HTTP_PORT=80
          NGINX_HTTPS_PORT=443
          CORS_ORIGIN=*
          # æ•°æ®åº“å­—ç¬¦é›†é…ç½®
          DB_CHARSET=utf8mb4
          DB_COLLATE=utf8mb4_0900_ai_ci
          EOF
          fi
          
          # ä½¿ç”¨ç»Ÿä¸€è„šæœ¬åœæ­¢æœåŠ¡
          chmod +x scripts/dev.sh
          scripts/dev.sh stop 2>/dev/null || docker-compose down 2>/dev/null || true
          
          # ä½¿ç”¨ç»Ÿä¸€è„šæœ¬å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
          scripts/dev.sh prod || docker-compose up -d --build
          
          # ç­‰å¾…æ•°æ®åº“æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æ•°æ®åº“æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²å¯åŠ¨
          echo "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
          max_db_attempts=20
          db_attempt=1
          while [ $db_attempt -le $max_db_attempts ]; do
            if docker-compose exec -T mysql mysqladmin ping -h localhost -u root -p$MYSQL_ROOT_PASSWORD 2>/dev/null; then
              echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
              break
            else
              echo "å°è¯• $db_attempt/$max_db_attempts: æ•°æ®åº“å°šæœªå°±ç»ªï¼Œç­‰å¾…5ç§’..."
              sleep 5
              db_attempt=$((db_attempt + 1))
            fi
          done
          
          # åˆå§‹åŒ–æ•°æ®åº“æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo "åˆå§‹åŒ–æ•°æ®åº“æ•°æ®..."
          if [ -f "database/init/01-init-database.sql" ]; then
            docker-compose exec -T mysql mysql -u root -p$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < database/init/01-init-database.sql
            echo "âœ… æ•°æ®åº“å·²åˆå§‹åŒ–"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬"
          fi
          
          # ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            # æ£€æŸ¥åç«¯APIå¥åº·çŠ¶æ€
            if curl -f http://localhost:$BACKEND_PORT/api/v1/health 2>/dev/null; then
              echo "âœ… åç«¯APIæœåŠ¡æ­£å¸¸"
              # æ£€æŸ¥Nginxä»£ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
              if curl -f http://localhost/health 2>/dev/null; then
                echo "âœ… Nginxä»£ç†æœåŠ¡æ­£å¸¸"
              else
                echo "âš ï¸  Nginxä»£ç†å¯èƒ½æœªå¯ç”¨ï¼Œä½†åç«¯æœåŠ¡æ­£å¸¸"
              fi
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
              ls -t backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
              exit 0
            else
              echo "å°è¯• $attempt/$max_attempts: æœåŠ¡å°šæœªå°±ç»ªï¼Œç­‰å¾…10ç§’..."
              echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€:"
              docker-compose ps
              sleep 10
              attempt=$((attempt + 1))
            fi
          done
          
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ŒæœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡"
          echo "æŸ¥çœ‹æœåŠ¡çŠ¶æ€:"
          docker-compose ps
          echo "æŸ¥çœ‹æ—¥å¿—:"
          docker-compose logs --tail=50
          exit 1

  # é€šçŸ¥
  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼åº”ç”¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"
          echo "ğŸŒ å‰ç«¯è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
          echo "ğŸ”— åç«¯APIåœ°å€: http://${{ secrets.SERVER_HOST }}:3000"  
          echo "ğŸ“‹ APIå¥åº·æ£€æŸ¥: http://${{ secrets.SERVER_HOST }}:3000/api/v1/health"
          echo "ğŸ“ è®ºå›åŠŸèƒ½: http://${{ secrets.SERVER_HOST }}/forum"
          echo "ğŸ“š èµ„æºä¸­å¿ƒ: http://${{ secrets.SERVER_HOST }}/resources"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—å¹¶é‡è¯•ã€‚"
        fi